６章：予測実施
load_model = 'model_XXXXXXXX.h5'  # 上で作成したモデルファイル名
model = tf.keras.models.load_model(load_model)

file_name3 = 'data3.csv'
df_tmp = pd.read_csv(file_name3)
df_tmp['race_date'] = pd.to_datetime(df_tmp['race_date']).dt.date
df = df_tmp.copy()
df = df[df['race_date'] >= datetime.date(2018, 1, 1)]

valid_kitaichi = df.pop('kitaichi')
valid_labels = df.pop('win3')
valid_date = df.pop('race_date')
valid_raceids = df.pop('race_id')
valid_odds = df.pop('odds')

# 学習時と列を揃える
all_columns = ['frame', 'futan', 'horse_num', 'run_count', 'age', 'weight_now', 'weight_gap', 'course_distance', 'past_days', 'past_course_distance1', 'past_time_sec1', 'past_rank1', 'past_pop1', 'past_odds1', 'past_course_distance2', 'past_time_sec2', 'past_rank2', 'past_pop2', 'past_odds2', 'past_course_distance3', 'past_time_sec3', 'past_rank3', 'past_pop3', 'past_odds3', 'past_course_distance4', 'past_time_sec4', 'past_rank4', 'past_pop4', 'past_odds4', 'past_course_distance5', 'past_time_sec5', 'past_rank5', 'past_pop5', 'past_odds5', 'sex_セ', 'sex_牝', 'sex_牡', 'sex_nan', 'place_中京', 'place_中山', 'place_京都', 'place_函館', 'place_小倉', 'place_新潟', 'place_札幌', 'place_東京', 'place_福島', 'place_阪神', 'place_nan', 'course_type_ダ', 'course_type_芝', 'course_type_障', 'course_type_nan', 'course_lr_右', 'course_lr_右 内2周', 'course_lr_右 外', 'course_lr_左', 'course_lr_左 外', 'course_lr_直線', 'course_lr_芝', 'course_lr_芝 ダート', 'course_lr_芝 内-外', 'course_lr_芝 外', 'course_lr_芝 外-内', 'course_lr_nan', 'weather_小雨', 'weather_小雪', 'weather_晴', 'weather_曇', 'weather_雨', 'weather_雪', 'weather_nan', 'ground_不良', 'ground_稍重', 'ground_良', 'ground_重', 'ground_nan', 'past_course_type1_ダ', 'past_course_type1_芝', 'past_course_type1_障', 'past_course_type1_nan', 'past_course_lr1_右', 'past_course_lr1_右 内2周', 'past_course_lr1_右 外', 'past_course_lr1_左', 'past_course_lr1_左 外', 'past_course_lr1_直線', 'past_course_lr1_芝', 'past_course_lr1_芝 ダート', 'past_course_lr1_芝 内-外', 'past_course_lr1_芝 外', 'past_course_lr1_芝 外-内', 'past_course_lr1_芝 左', 'past_course_lr1_nan', 'past_weather1_小雨', 'past_weather1_小雪', 'past_weather1_晴', 'past_weather1_曇', 'past_weather1_雨', 'past_weather1_雪', 'past_weather1_nan', 'past_ground1_不良', 'past_ground1_稍重', 'past_ground1_良', 'past_ground1_重', 'past_ground1_nan', 'past_gap1_1', 'past_gap1_1+1.1/2', 'past_gap1_1+1/2', 'past_gap1_1.1/2', 'past_gap1_1.1/2+2', 'past_gap1_1.1/4', 'past_gap1_1.1/4+2.1/2', 'past_gap1_1.1/4+3/4', 'past_gap1_1.1/4+クビ', 'past_gap1_1.1/4+ハナ', 'past_gap1_1.3/4', 'past_gap1_1.3/4+2.1/2', 'past_gap1_1/2', 'past_gap1_1/2+2.1/2', 'past_gap1_1/2+アタマ', 'past_gap1_1/2+クビ', 'past_gap1_1/2+ハナ', 'past_gap1_10', 'past_gap1_11位降着', 'past_gap1_12位降着', 'past_gap1_15位降着', 'past_gap1_1位降着', 'past_gap1_2', 'past_gap1_2+1/2', 'past_gap1_2+アタマ', 'past_gap1_2.1/2', 'past_gap1_2.1/2+ハナ', 'past_gap1_2位降着', 'past_gap1_3', 'past_gap1_3.1/2', 'past_gap1_3/4', 'past_gap1_3/4+アタマ', 'past_gap1_3/4+クビ', 'past_gap1_3/4+ハナ', 'past_gap1_3位降着', 'past_gap1_4', 'past_gap1_4位降着', 'past_gap1_5', 'past_gap1_5+3', 'past_gap1_5位降着', 'past_gap1_6', 'past_gap1_6位降着', 'past_gap1_7', 'past_gap1_7位降着', 'past_gap1_8', 'past_gap1_8位降着', 'past_gap1_9', 'past_gap1_9位降着', 'past_gap1_アタマ', 'past_gap1_クビ', 'past_gap1_クビ+1', 'past_gap1_クビ+1.1/2', 'past_gap1_クビ+1.1/4', 'past_gap1_クビ+1.3/4', 'past_gap1_クビ+1/2', 'past_gap1_クビ+2', 'past_gap1_クビ+2.1/2', 'past_gap1_クビ+3', 'past_gap1_クビ+3/4', 'past_gap1_クビ+アタマ', 'past_gap1_クビ+クビ', 'past_gap1_クビ+ハナ', 'past_gap1_ハナ', 'past_gap1_ハナ+1.1/4', 'past_gap1_ハナ+3/4', 'past_gap1_ハナ+クビ', 'past_gap1_大', 'past_gap1_nan', 'past_course_type2_ダ', 'past_course_type2_芝', 'past_course_type2_障', 'past_course_type2_nan', 'past_course_lr2_右', 'past_course_lr2_右 内2周', 'past_course_lr2_右 外', 'past_course_lr2_左', 'past_course_lr2_左 外', 'past_course_lr2_直線', 'past_course_lr2_芝', 'past_course_lr2_芝 ダート', 'past_course_lr2_芝 内-外', 'past_course_lr2_芝 外', 'past_course_lr2_芝 外-内', 'past_course_lr2_芝 左', 'past_course_lr2_nan', 'past_weather2_小雨', 'past_weather2_小雪', 'past_weather2_晴', 'past_weather2_曇', 'past_weather2_雨', 'past_weather2_雪', 'past_weather2_nan', 'past_ground2_不良', 'past_ground2_稍重', 'past_ground2_良', 'past_ground2_重', 'past_ground2_nan', 'past_gap2_1', 'past_gap2_1+1.1/2', 'past_gap2_1+1/2', 'past_gap2_1.1/2', 'past_gap2_1.1/2+2', 'past_gap2_1.1/2+3.1/2', 'past_gap2_1.1/4', 'past_gap2_1.1/4+2.1/2', 'past_gap2_1.1/4+3/4', 'past_gap2_1.1/4+クビ', 'past_gap2_1.1/4+ハナ', 'past_gap2_1.3/4', 'past_gap2_1.3/4+2.1/2', 'past_gap2_1/2', 'past_gap2_1/2+2.1/2', 'past_gap2_1/2+3', 'past_gap2_1/2+アタマ', 'past_gap2_1/2+クビ', 'past_gap2_1/2+ハナ', 'past_gap2_10', 'past_gap2_11位降着', 'past_gap2_15位降着', 'past_gap2_1位降着', 'past_gap2_2', 'past_gap2_2+アタマ', 'past_gap2_2+クビ', 'past_gap2_2.1/2', 'past_gap2_2.1/2+ハナ', 'past_gap2_2位降着', 'past_gap2_3', 'past_gap2_3.1/2', 'past_gap2_3/4', 'past_gap2_3/4+アタマ', 'past_gap2_3/4+クビ', 'past_gap2_3/4+ハナ', 'past_gap2_3位降着', 'past_gap2_4', 'past_gap2_4位降着', 'past_gap2_5', 'past_gap2_5+3', 'past_gap2_5位降着', 'past_gap2_6', 'past_gap2_6位降着', 'past_gap2_7', 'past_gap2_7位降着', 'past_gap2_8', 'past_gap2_8位降着', 'past_gap2_9', 'past_gap2_9位降着', 'past_gap2_アタマ', 'past_gap2_アタマ+クビ', 'past_gap2_クビ', 'past_gap2_クビ+1', 'past_gap2_クビ+1.1/2', 'past_gap2_クビ+1.1/4', 'past_gap2_クビ+1.3/4', 'past_gap2_クビ+1/2', 'past_gap2_クビ+2', 'past_gap2_クビ+2.1/2', 'past_gap2_クビ+3', 'past_gap2_クビ+3/4', 'past_gap2_クビ+アタマ', 'past_gap2_クビ+クビ', 'past_gap2_クビ+ハナ', 'past_gap2_ハナ', 'past_gap2_ハナ+1.1/4', 'past_gap2_ハナ+3/4', 'past_gap2_ハナ+クビ', 'past_gap2_同着', 'past_gap2_大', 'past_gap2_nan', 'past_course_type3_ダ', 'past_course_type3_芝', 'past_course_type3_障', 'past_course_type3_nan', 'past_course_lr3_右', 'past_course_lr3_右 内2周', 'past_course_lr3_右 外', 'past_course_lr3_左', 'past_course_lr3_左 外', 'past_course_lr3_直線', 'past_course_lr3_芝', 'past_course_lr3_芝 ダート', 'past_course_lr3_芝 内-外', 'past_course_lr3_芝 外', 'past_course_lr3_芝 外-内', 'past_course_lr3_芝 左', 'past_course_lr3_nan', 'past_weather3_小雨', 'past_weather3_小雪', 'past_weather3_晴', 'past_weather3_曇', 'past_weather3_雨', 'past_weather3_雪', 'past_weather3_nan', 'past_ground3_不良', 'past_ground3_稍重',
               'past_ground3_良', 'past_ground3_重', 'past_ground3_nan', 'past_gap3_1', 'past_gap3_1+1.1/2', 'past_gap3_1+1/2', 'past_gap3_1.1/2', 'past_gap3_1.1/2+2', 'past_gap3_1.1/4', 'past_gap3_1.1/4+2.1/2', 'past_gap3_1.1/4+3/4', 'past_gap3_1.1/4+クビ', 'past_gap3_1.1/4+ハナ', 'past_gap3_1.3/4', 'past_gap3_1.3/4+1/2', 'past_gap3_1.3/4+2.1/2', 'past_gap3_1/2', 'past_gap3_1/2+1.1/2', 'past_gap3_1/2+2.1/2', 'past_gap3_1/2+3', 'past_gap3_1/2+アタマ', 'past_gap3_1/2+クビ', 'past_gap3_1/2+ハナ', 'past_gap3_10', 'past_gap3_11位降着', 'past_gap3_15位降着', 'past_gap3_1位降着', 'past_gap3_2', 'past_gap3_2+アタマ', 'past_gap3_2+クビ', 'past_gap3_2.1/2', 'past_gap3_2.1/2+ハナ', 'past_gap3_2位降着', 'past_gap3_3', 'past_gap3_3.1/2', 'past_gap3_3/4', 'past_gap3_3/4+アタマ', 'past_gap3_3/4+クビ', 'past_gap3_3/4+ハナ', 'past_gap3_3位降着', 'past_gap3_4', 'past_gap3_4位降着', 'past_gap3_5', 'past_gap3_5位降着', 'past_gap3_6', 'past_gap3_6位降着', 'past_gap3_7', 'past_gap3_7位降着', 'past_gap3_8', 'past_gap3_8位降着', 'past_gap3_9', 'past_gap3_9位降着', 'past_gap3_アタマ', 'past_gap3_アタマ+クビ', 'past_gap3_クビ', 'past_gap3_クビ+1', 'past_gap3_クビ+1.1/2', 'past_gap3_クビ+1.1/4', 'past_gap3_クビ+1.3/4', 'past_gap3_クビ+1/2', 'past_gap3_クビ+2', 'past_gap3_クビ+2.1/2', 'past_gap3_クビ+3', 'past_gap3_クビ+3/4', 'past_gap3_クビ+クビ', 'past_gap3_クビ+ハナ', 'past_gap3_ハナ', 'past_gap3_ハナ+1.1/4', 'past_gap3_ハナ+3/4', 'past_gap3_同着', 'past_gap3_大', 'past_gap3_nan', 'past_course_type4_ダ', 'past_course_type4_芝', 'past_course_type4_障', 'past_course_type4_nan', 'past_course_lr4_右', 'past_course_lr4_右 内2周', 'past_course_lr4_右 外', 'past_course_lr4_左', 'past_course_lr4_左 外', 'past_course_lr4_直線', 'past_course_lr4_芝', 'past_course_lr4_芝 ダート', 'past_course_lr4_芝 内-外', 'past_course_lr4_芝 外', 'past_course_lr4_芝 外-内', 'past_course_lr4_芝 左', 'past_course_lr4_nan', 'past_weather4_小雨', 'past_weather4_小雪', 'past_weather4_晴', 'past_weather4_曇', 'past_weather4_雨', 'past_weather4_雪', 'past_weather4_nan', 'past_ground4_不良', 'past_ground4_稍重', 'past_ground4_良', 'past_ground4_重', 'past_ground4_nan', 'past_gap4_1', 'past_gap4_1+1.1/2', 'past_gap4_1.1/2', 'past_gap4_1.1/2+2', 'past_gap4_1.1/4', 'past_gap4_1.1/4+1.1/2', 'past_gap4_1.1/4+2.1/2', 'past_gap4_1.1/4+3/4', 'past_gap4_1.1/4+クビ', 'past_gap4_1.1/4+ハナ', 'past_gap4_1.3/4', 'past_gap4_1.3/4+1/2', 'past_gap4_1.3/4+2.1/2', 'past_gap4_1/2', 'past_gap4_1/2+1.1/2', 'past_gap4_1/2+1.1/4', 'past_gap4_1/2+2.1/2', 'past_gap4_1/2+3', 'past_gap4_1/2+アタマ', 'past_gap4_1/2+クビ', 'past_gap4_1/2+ハナ', 'past_gap4_10', 'past_gap4_10位降着', 'past_gap4_11位降着', 'past_gap4_15位降着', 'past_gap4_1位降着', 'past_gap4_2', 'past_gap4_2+アタマ', 'past_gap4_2+クビ', 'past_gap4_2+ハナ', 'past_gap4_2.1/2', 'past_gap4_2.1/2+ハナ', 'past_gap4_2位降着', 'past_gap4_3', 'past_gap4_3+大', 'past_gap4_3.1/2', 'past_gap4_3/4', 'past_gap4_3/4+1.1/4', 'past_gap4_3/4+2.1/2', 'past_gap4_3/4+3/4', 'past_gap4_3/4+アタマ', 'past_gap4_3/4+クビ', 'past_gap4_3/4+ハナ', 'past_gap4_3位降着', 'past_gap4_4', 'past_gap4_4位降着', 'past_gap4_5', 'past_gap4_5位降着', 'past_gap4_6', 'past_gap4_6位降着', 'past_gap4_7', 'past_gap4_7位降着', 'past_gap4_8', 'past_gap4_8位降着', 'past_gap4_9', 'past_gap4_9位降着', 'past_gap4_アタマ', 'past_gap4_アタマ+クビ', 'past_gap4_クビ', 'past_gap4_クビ+1', 'past_gap4_クビ+1.1/2', 'past_gap4_クビ+1.1/4', 'past_gap4_クビ+1.3/4', 'past_gap4_クビ+1/2', 'past_gap4_クビ+2', 'past_gap4_クビ+2.1/2', 'past_gap4_クビ+3', 'past_gap4_クビ+3/4', 'past_gap4_クビ+クビ', 'past_gap4_クビ+ハナ', 'past_gap4_ハナ', 'past_gap4_ハナ+1.1/4', 'past_gap4_ハナ+3/4', 'past_gap4_ハナ+クビ', 'past_gap4_同着', 'past_gap4_大', 'past_gap4_nan', 'past_course_type5_ダ', 'past_course_type5_芝', 'past_course_type5_障', 'past_course_type5_nan', 'past_course_lr5_右', 'past_course_lr5_右 内2周', 'past_course_lr5_右 外', 'past_course_lr5_左', 'past_course_lr5_左 外', 'past_course_lr5_直線', 'past_course_lr5_芝', 'past_course_lr5_芝 ダート', 'past_course_lr5_芝 内-外', 'past_course_lr5_芝 外', 'past_course_lr5_芝 外-内', 'past_course_lr5_芝 左', 'past_course_lr5_nan', 'past_weather5_小雨', 'past_weather5_小雪', 'past_weather5_晴', 'past_weather5_曇', 'past_weather5_雨', 'past_weather5_雪', 'past_weather5_nan', 'past_ground5_不良', 'past_ground5_稍重', 'past_ground5_良', 'past_ground5_重', 'past_ground5_nan', 'past_gap5_1', 'past_gap5_1+1.1/2', 'past_gap5_1.1/2', 'past_gap5_1.1/2+2', 'past_gap5_1.1/2+クビ', 'past_gap5_1.1/4', 'past_gap5_1.1/4+1.1/2', 'past_gap5_1.1/4+2.1/2', 'past_gap5_1.1/4+3/4', 'past_gap5_1.1/4+クビ', 'past_gap5_1.1/4+ハナ', 'past_gap5_1.3/4', 'past_gap5_1.3/4+1/2', 'past_gap5_1.3/4+2.1/2', 'past_gap5_1/2', 'past_gap5_1/2+1.1/2', 'past_gap5_1/2+1.1/4', 'past_gap5_1/2+2.1/2', 'past_gap5_1/2+3', 'past_gap5_1/2+アタマ', 'past_gap5_1/2+クビ', 'past_gap5_1/2+ハナ', 'past_gap5_10', 'past_gap5_10位降着', 'past_gap5_11位降着', 'past_gap5_15位降着', 'past_gap5_1位降着', 'past_gap5_2', 'past_gap5_2+3/4', 'past_gap5_2+アタマ', 'past_gap5_2+クビ', 'past_gap5_2+ハナ', 'past_gap5_2.1/2', 'past_gap5_2.1/2+3/4', 'past_gap5_2.1/2+ハナ', 'past_gap5_2位降着', 'past_gap5_3', 'past_gap5_3+大', 'past_gap5_3.1/2', 'past_gap5_3/4', 'past_gap5_3/4+1.1/4', 'past_gap5_3/4+2.1/2', 'past_gap5_3/4+3/4', 'past_gap5_3/4+アタマ', 'past_gap5_3/4+クビ', 'past_gap5_3/4+ハナ', 'past_gap5_3位降着', 'past_gap5_4', 'past_gap5_4位降着', 'past_gap5_5', 'past_gap5_5位降着', 'past_gap5_6', 'past_gap5_6位降着', 'past_gap5_7', 'past_gap5_7位降着', 'past_gap5_8', 'past_gap5_8位降着', 'past_gap5_9', 'past_gap5_9位降着', 'past_gap5_アタマ', 'past_gap5_アタマ+クビ', 'past_gap5_クビ', 'past_gap5_クビ+1', 'past_gap5_クビ+1.1/2', 'past_gap5_クビ+1.1/4', 'past_gap5_クビ+1.3/4', 'past_gap5_クビ+2', 'past_gap5_クビ+2.1/2', 'past_gap5_クビ+3', 'past_gap5_クビ+3/4', 'past_gap5_クビ+クビ', 'past_gap5_クビ+ハナ', 'past_gap5_ハナ', 'past_gap5_ハナ+1.1/4', 'past_gap5_ハナ+10', 'past_gap5_ハナ+3/4', 'past_gap5_同着', 'past_gap5_大', 'past_gap5_nan']

df = df[all_columns]

# 予測
predict = model.predict(df)
df['win3_pred'] = predict

df['kitaichi'] = valid_kitaichi.values
df['odds'] = valid_odds.values
df['race_id'] = valid_raceids.values
df['race_date'] = valid_date.values
df['win3'] = valid_labels.values

# 複勝2頭以上、全5頭以上レースに絞る
win3_sums = df.groupby('race_id')['win3'].sum()
win3_races = win3_sums[win3_sums >= 2]
win3_races_indexs = win3_races.index.tolist()

win3_counts = df.groupby('race_id')['win3'].count()
win3_races2 = win3_counts[win3_counts >= 5]
win3_races_indexs2 = win3_races2.index.tolist()

race_id_list = list(set(win3_races_indexs) & set(win3_races_indexs2))
all_record_count = len(df[df['race_id'].isin(race_id_list)])

all_race_id_list = df['race_id'].unique().tolist()
print(f'購入レース数：{len(race_id_list)} / {len(all_race_id_list)}')
print(f'全レコード数：{all_record_count}')

df_pred = df[df['race_id'].isin(race_id_list)]
